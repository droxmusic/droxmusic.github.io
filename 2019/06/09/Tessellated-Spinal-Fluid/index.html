<!DOCTYPE html>
<html lang=en>
<head><meta name="generator" content="Hexo 3.8.0">
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="IntroductionHardware design is difficult but rewarding. One of the main aspects is the sheer difficulty in using a Hardware Description Language (HDL) like (System)Verilog and VHDL. I feel that others">
<meta property="og:type" content="article">
<meta property="og:title" content="Tessellated_Spinal_Fluid">
<meta property="og:url" content="http://drox.zone/2019/06/09/Tessellated-Spinal-Fluid/index.html">
<meta property="og:site_name" content="Derrick Miller">
<meta property="og:description" content="IntroductionHardware design is difficult but rewarding. One of the main aspects is the sheer difficulty in using a Hardware Description Language (HDL) like (System)Verilog and VHDL. I feel that others">
<meta property="og:locale" content="en-US">
<meta property="og:updated_time" content="2020-02-21T16:17:53.036Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Tessellated_Spinal_Fluid">
<meta name="twitter:description" content="IntroductionHardware design is difficult but rewarding. One of the main aspects is the sheer difficulty in using a Hardware Description Language (HDL) like (System)Verilog and VHDL. I feel that others">
    
    
        
          
              <link rel="shortcut icon" href="https://www.gravatar.com/avatar/90f75cf8999af265d550653f7cdf4d39?s=16">
          
        
        
          
            <link rel="icon" type="image/png" href="https://www.gravatar.com/avatar/90f75cf8999af265d550653f7cdf4d39?s=192" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="https://www.gravatar.com/avatar/90f75cf8999af265d550653f7cdf4d39?s=180">
          
        
    
    <!-- title -->
    <title>Tessellated_Spinal_Fluid</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- persian styles -->
    
      <link rel="stylesheet" href="/css/rtl.css">
    
    <!-- rss -->
    
    
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writings</a></li>
         
          <li><a href="https://droxpopuli.bandcamp.com">Music</a></li>
         
          <li><a href="https://github.com/droxpopuli">Code</a></li>
        
      </ul>
    </span>
    <br>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2020/02/21/hello-world/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Post Anterior</span>
      <span id="i-next" class="info" style="display:none;">Post Següent</span>
      <span id="i-top" class="info" style="display:none;">Adalt</span>
      <span id="i-share" class="info" style="display:none;">Compartir Post</span>
    </span>
    <br>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://drox.zone/2019/06/09/Tessellated-Spinal-Fluid/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://drox.zone/2019/06/09/Tessellated-Spinal-Fluid/&text=Tessellated_Spinal_Fluid"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://drox.zone/2019/06/09/Tessellated-Spinal-Fluid/&title=Tessellated_Spinal_Fluid"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://drox.zone/2019/06/09/Tessellated-Spinal-Fluid/&is_video=false&description=Tessellated_Spinal_Fluid"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Tessellated_Spinal_Fluid&body=Check out this article: http://drox.zone/2019/06/09/Tessellated-Spinal-Fluid/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://drox.zone/2019/06/09/Tessellated-Spinal-Fluid/&title=Tessellated_Spinal_Fluid"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://drox.zone/2019/06/09/Tessellated-Spinal-Fluid/&title=Tessellated_Spinal_Fluid"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://drox.zone/2019/06/09/Tessellated-Spinal-Fluid/&title=Tessellated_Spinal_Fluid"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://drox.zone/2019/06/09/Tessellated-Spinal-Fluid/&title=Tessellated_Spinal_Fluid"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://drox.zone/2019/06/09/Tessellated-Spinal-Fluid/&name=Tessellated_Spinal_Fluid&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Introduction"><span class="toc-number">1.</span> <span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Growing-a-Spine-al"><span class="toc-number">2.</span> <span class="toc-text">Growing a Spine(al)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#The-Task-The-TIS-100"><span class="toc-number">3.</span> <span class="toc-text">The Task: The TIS-100</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#The-Datapath"><span class="toc-number">4.</span> <span class="toc-text">The Datapath</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#IO"><span class="toc-number">4.1.</span> <span class="toc-text">IO</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Going-Beyond-the-Zach"><span class="toc-number">4.2.</span> <span class="toc-text">Going Beyond the Zach</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Accumulate-Your-Backups"><span class="toc-number">4.3.</span> <span class="toc-text">Accumulate Your Backups</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Connect-me-to-the-Operator-Please"><span class="toc-number">4.4.</span> <span class="toc-text">Connect me to the Operator Please</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Spinal-Clamp"><span class="toc-number">4.5.</span> <span class="toc-text">Spinal Clamp</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Putting-it-All-Together"><span class="toc-number">4.6.</span> <span class="toc-text">Putting it All Together</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Simulation"><span class="toc-number">5.</span> <span class="toc-text">Simulation</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#The-Golden-Goose"><span class="toc-number">5.1.</span> <span class="toc-text">The Golden Goose</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Assert-My-Authority"><span class="toc-number">5.2.</span> <span class="toc-text">Assert My Authority</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Building-the-Simulation"><span class="toc-number">5.3.</span> <span class="toc-text">Building the Simulation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Running-the-Simulation"><span class="toc-number">5.4.</span> <span class="toc-text">Running the Simulation</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Appendix-Codes"><span class="toc-number">6.</span> <span class="toc-text">Appendix: Codes</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#T21Datapath-scala"><span class="toc-number">6.1.</span> <span class="toc-text">T21Datapath.scala</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#T21DatapathSim-scala"><span class="toc-number">6.2.</span> <span class="toc-text">T21DatapathSim.scala</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Tessellated_Spinal_Fluid
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Derrick Miller</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2019-06-10T00:22:57.000Z" itemprop="datePublished">2019-06-09</time>
        
        (Updated: <time datetime="2020-02-21T16:17:53.036Z" itemprop="dateModified">2020-02-21</time>)
        
      
    </div>


      

      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>Hardware design is difficult but rewarding. One of the main aspects is the sheer difficulty in using a Hardware Description Language (HDL) like (System)Verilog and VHDL. I feel that <a href="https://danluu.com/why-hardware-development-is-hard/" target="_blank" rel="noopener">others have been able to elaborate on this far better than I.</a> For that reason I wont really go into what makes it difficult on a syntax level in itself (although the syntax is quite a large aspect of the issue).</p>
<p>What I care about are the conceptual barriers that plagued my fellow students and I during my undergraduate years, particularly in the Digital System Design course. In that, we used Quartus with pure SystemVerilog to develop on an Altera DE2-115. Probably the biggest hurdle was being able to take what felt like a very abstract set of almost C-like primitives and applying them to a dataflow or event-driven model. Too often I caught myself and group mates writing in an imperative way when the concept of program control flow does not even apply.</p>
<p>I enjoyed planning out designs on paper, sketching block diagrams and linking parts together into a meaningful whole. With a well established blocking of the design, Verilog would allow for this on a high level, but there still was the task of designing module internals which was either a total chore with handwritten Verilog, or opaquely handled for us with IP generators. Don’t even get me started on test-benching. When I moved from Quartus to Vivado for a sensors course, I felt like I had to completely relearn proper test-benching and I’m quite confident that it was not robust whatsoever.</p>
<p>By the end of my sensor course I had honestly thought I wasn’t really going to be going too hard on Digital Design opting more for embedded hardware where I could link together systems on a high level and then write C or Rust firmware to handle everything. But I had an iCE40 board laying around that I was determined to make use of, so I started forcing myself to learn Verilog that I could pass to yosys or run through Verilator which lasted about a week.</p>
<h2 id="Growing-a-Spine-al"><a href="#Growing-a-Spine-al" class="headerlink" title="Growing a Spine(al)"></a>Growing a Spine(al)</h2><p>That actually has changed for me today with me finding <a href="https://github.com/SpinalHDL/SpinalHDL" target="_blank" rel="noopener">SpinalHDL</a>, a DSL written in Scala that puts you a level or two higher in abstraction compared to Verilog or VHDL. Spinal lets you describe in text, what I have been doing in my notebook sketches. Not only can one describe the layout and linkage of component modules, but the entire event driven concept is thrown out for a purely schematic and behavioral paradigm.</p>
<p>This is a big deal as one is no longer writing code to describe precise reaction to events or signal changes but instead you can write in a way where you can imagine and visualize what exactly it is you are writing, like you are placing and wiring parts on a breadboard. When this is done in a language with Object Oriented capabilities like SpinalHDL does by being embedded in Scala, the hardware generation flexibility makes VHDL and Verilog paramterization feel like tinker toys.</p>
<h2 id="The-Task-The-TIS-100"><a href="#The-Task-The-TIS-100" class="headerlink" title="The Task: The TIS-100"></a>The Task: The TIS-100</h2><p>To give an example I must introduce a small problem space. <a href="http://www.zachtronics.com/" target="_blank" rel="noopener">Zachtronics</a> is a game development studio that puts out engineering puzzles games involving automata, programming, and systems design. Of note are their games involving somewhat esoteric programming for systems that only exist in the game world. <a href="http://www.zachtronics.com/shenzhen-io" target="_blank" rel="noopener">Shenzhen I/O</a> lets one do embedded development on limited micro-controllers as an expat in near-future China, <a href="http://www.zachtronics.com/exapunks" target="_blank" rel="noopener">EXAPUNKS</a> lets you “HACK THE PLANET” in a 90s style setting that sometimes feels more like a heist game than it does programming. However, I have always been entranced by the one I am probably the worst at: <a href="http://www.zachtronics.com/tis-100" target="_blank" rel="noopener">TIS-100</a>.</p>
<p>In TIS-100, one programs an incredibly parallel machine made up of a 4x3 grid of simple processor cores (called T21s) each connected to their cardinal neighbors. These cores have a very small data storage in the form of accumulator and backup registers, each able to hold a value between -999 and 999, clamping if an operation attempts to go beyond those limits. The operations themselves are very simple. A far as the datapath is concerned (we will come to instructions and jumps another time), one can only:</p>
<p>1) ADD: Add to the Accumulator,<br>2) SUB: Subtract from the Accumulator,<br>3) NEG: Negate the Accumulator,<br>4) BAK: Store the Accumulator in the Backup Register,<br>5) SWP: Swap the Accumulator and Backup Register, or<br>6) MOV: Move a value from an external port into the accumulator (or vice versa).</p>
<p>And that. is. it. (okay I lied there is a NOP but that can be folded into ADD or SUB with an operand of 0)</p>
<p>This simplicity has always been fascinating to me as it felt like something that I could try to implement in hardware, but my problems with Verilog always turned what was fun on paper into a task that honestly was not very fun. SpinalHDL makes things very different.</p>
<h2 id="The-Datapath"><a href="#The-Datapath" class="headerlink" title="The Datapath"></a>The Datapath</h2><p>In the span of a day, I was able to pickup SpinalHDL and build not only a prototype datapath (the registers and ALU), but a passing testbench that can all be part of a T21-compatible design core. I will go section by section through my design and test bench to give a glimpse into how smooth SpinalHDL can be to work with while also elaborating on how to approach digital design as a whole when one doesn’t have to worry about the event-driven paradigm.</p>
<p>Extending off of the SpinalHDL Component class (the equivalent of a module in Verilog), we may begin.</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> <span class="type">TIS100</span>.<span class="type">T21</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> spinal.core._</span><br><span class="line"><span class="keyword">import</span> spinal.lib._</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">T21Datapath</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="IO"><a href="#IO" class="headerlink" title="IO"></a>IO</h3><p>Assuming its general specification has already been layed out like I did earlier, the first part of making a hardware component (for me) is specifying the input and output of the device.</p>
<p>For the T21 Datapath, we only need to have a single output for the accumulator, a single input for the operand, an operation selector to select the input multiplexers for the registers, and an enable line, which runs the whole system once every clock cycle when high.</p>
<p>In Spinal this is done the declaring a <code>Bundle</code> of signals called <code>io</code> and filling it with inputs and outputs of various Spinal <code>Data</code> types:</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[...] <span class="comment">// This is a snip, meaning code from before is still there</span></span><br><span class="line"><span class="comment">// It is just being left out to focus on what has been added or changed.</span></span><br><span class="line"><span class="comment">// Full code blocks will be pasted at different points in the article.</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">T21ALUOp</span> <span class="keyword">extends</span> <span class="title">SpinalEnum</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">val</span> op_bak, op_swp, op_add, op_sub, op_neg, op_mov = newElement()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">T21Datapath</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="keyword">val</span> io = <span class="keyword">new</span> <span class="type">Bundle</span> &#123;</span><br><span class="line">    <span class="keyword">val</span> imm    = in  <span class="type">SInt</span>(<span class="number">16</span> bits)</span><br><span class="line">    <span class="keyword">val</span> alu_op = in  (<span class="type">T21ALUOp</span>())</span><br><span class="line">    <span class="keyword">val</span> dout   = out <span class="type">SInt</span>(<span class="number">16</span> bits)</span><br><span class="line">    <span class="keyword">val</span> en     = in  <span class="type">Bool</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>There is a lot going on here so I will break it down. First we want to help ourselves out by making an Enumeration of the different operations our datapath can perform. This is what the <code>SpinalEnum</code> object does for us, letting us completely abstract away the encoding of the enumeration. I also put it outside of the <code>Component</code> for reasons that will become clear later.</p>
<p>Within our declared <code>io</code> <code>Bundle</code> we have our four io mentioned earlier. This simply involves declaring an <code>in</code> or <code>out</code> along with the type of the signal. <code>SInt(16 bits)</code> declares a signed integer of 16 bits width while a <code>Bool</code> is a hardware boolean, a single bit. The operation selector <code>alu_op</code> is declared as an input signal of the type of our enumeration, whatever it may be, it doesn’t matter as we can just refer to it via the enum members.</p>
<h3 id="Going-Beyond-the-Zach"><a href="#Going-Beyond-the-Zach" class="headerlink" title="Going Beyond the Zach"></a>Going Beyond the Zach</h3><p>So the astute reader will notice I used 16 bits for the immediate value and data output while only 11 bits are needed to represent the range of -999 to 999. I did this for a few reasons that have to do with a bit encoding of the instructions being 16 bits wide and using a common data bus, but in all honesty I can probably cull the number of bits and lines down to the minimum 11 to be efficient, the extra bits just make the saturated operation easier down the road. We are better than that, though. What if we wanted out T21 to have a greater set of value limits? Perhaps we want some EXA hybrid that lets us go from -9999 to 9999 or work with base 2 limits. Here is where Spinal shines. We can parameterize the limits of the of computation like so:</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">T21Datapath</span>(<span class="params">abs_limit: <span class="type">Int</span></span>) <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="keyword">val</span> width = log2Up(<span class="number">2</span>*abs_limit+<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">val</span> io = <span class="keyword">new</span> <span class="type">Bundle</span> &#123;</span><br><span class="line">    <span class="keyword">val</span> imm    = in  <span class="type">SInt</span>(width bits)</span><br><span class="line">    <span class="keyword">val</span> alu_op = in  (<span class="type">T21ALUOp</span>())</span><br><span class="line">    <span class="keyword">val</span> dout   = out <span class="type">SInt</span>(width bits)</span><br><span class="line">    <span class="keyword">val</span> en     = in  <span class="type">Bool</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Here we put in a parameter to the class and get a number of required bits to represent the number of values we need. Using <code>log2Up()</code> we then get an <code>Int</code> of the number of bits needed which we can then pass to the input. For the rest of this exercise we are going to design in a form that will allow for us to work with any value from <code>-abs_limit</code> to <code>abs_limit</code>.</p>
<h3 id="Accumulate-Your-Backups"><a href="#Accumulate-Your-Backups" class="headerlink" title="Accumulate Your Backups"></a>Accumulate Your Backups</h3><p>With all that boilerplate out of the way, we can finally start to define the internals of the system. Registers are what are operated on so it only makes sense to do that first, in Spinal it is done quite easily:</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">T21Datapath</span>(<span class="params">abs_limit: <span class="type">Int</span></span>) <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="keyword">val</span> width = log2Up(<span class="number">2</span>*abs_limit+<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">  [...]</span><br><span class="line"></span><br><span class="line">  <span class="keyword">val</span> acc = <span class="type">Reg</span>(<span class="type">SInt</span>(width bits)) init(<span class="number">0</span>)</span><br><span class="line">  <span class="keyword">val</span> bak = <span class="type">Reg</span>(<span class="type">SInt</span>(width bits)) init(<span class="number">0</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>That’s all, a <code>Reg()</code> with a declared <code>Data</code> type is passed and we then <code>init()</code> the register to a value of choice, in our case 0. This value is also what is put in the register upon a reset. Our accumulator is always reflected as the <code>dout</code> in the <code>io</code> <code>Bundle</code> so let us connect with with the concurrent assignment operator.</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">T21Datapath</span>(<span class="params">abs_limit: <span class="type">Int</span></span>) <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  [...]</span><br><span class="line"></span><br><span class="line">  <span class="keyword">val</span> acc = <span class="type">Reg</span>(<span class="type">SInt</span>(width bits)) init(<span class="number">0</span>)</span><br><span class="line">  <span class="keyword">val</span> bak = <span class="type">Reg</span>(<span class="type">SInt</span>(width bits)) init(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">  io.dout := acc</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Simple so far although note we have to mention that we care connection to <code>dout</code> on the <code>io</code> <code>Bundle</code> Now we get more complex and need to describe behavior. This is done with <code>when</code> and <code>switch</code> blocks:</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">T21Datapath</span>(<span class="params">abs_limit: <span class="type">Int</span></span>) <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  [...]</span><br><span class="line"></span><br><span class="line">  when(io.en) &#123;</span><br><span class="line">    <span class="comment">// Accumulator is written to on all but BAK instructions</span></span><br><span class="line">    switch(io.alu_op)&#123;</span><br><span class="line">      is(<span class="type">T21ALUOp</span>.op_swp) &#123; acc := ??? &#125;</span><br><span class="line">      is(<span class="type">T21ALUOp</span>.op_add) &#123; acc := ??? &#125;</span><br><span class="line">      is(<span class="type">T21ALUOp</span>.op_sub) &#123; acc := ??? &#125;</span><br><span class="line">      is(<span class="type">T21ALUOp</span>.op_neg) &#123; acc := ??? &#125;</span><br><span class="line">      is(<span class="type">T21ALUOp</span>.op_mov) &#123; acc := ??? &#125;</span><br><span class="line">                  <span class="keyword">default</span> &#123; acc := acc &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Backup writes are only happen on BAK and SWP</span></span><br><span class="line">    switch(io.alu_op)&#123;</span><br><span class="line">      is(<span class="type">T21ALUOp</span>.op_bak) &#123; bak := ??? &#125;</span><br><span class="line">      is(<span class="type">T21ALUOp</span>.op_swp) &#123; bak := ??? &#125;</span><br><span class="line">                  <span class="keyword">default</span> &#123; bak := bak &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; otherwise &#123;</span><br><span class="line">    acc := acc</span><br><span class="line">    bak := bak</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  [...]</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>When is essentially an <code>if</code> statement with <code>otherwise</code> as an else. So this says when <code>io.en</code> is up, we are going to assign to the <code>ACC</code> and <code>BAK</code> some value that <em>isn’t</em> themselves. The <code>switch</code> and <code>is</code> blocks are like a <code>switch/case</code> and here we can see our Enumeration pop up, again abstracting away the actual encoding. Why do the self-assigns on otherwise and default cases? To avoid latches.</p>
<p>Note: I would actually like to also say that in Scala the <code>???</code> is a built-in that represent an unimplemented or TODO kind of concept.</p>
<h3 id="Connect-me-to-the-Operator-Please"><a href="#Connect-me-to-the-Operator-Please" class="headerlink" title="Connect me to the Operator Please"></a>Connect me to the Operator Please</h3><p>So let us fill in these assignments, right off the bat we can easily do <code>SWP</code>, <code>MOV</code>, and <code>BAK</code>.</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">T21Datapath</span>(<span class="params">abs_limit: <span class="type">Int</span></span>) <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  [...]</span><br><span class="line"></span><br><span class="line">  when(io.en) &#123;</span><br><span class="line">    <span class="comment">// Accumulator is written to on all but BAK instructions</span></span><br><span class="line">    switch(io.alu_op)&#123;</span><br><span class="line">      is(<span class="type">T21ALUOp</span>.op_swp) &#123; acc := bak &#125;</span><br><span class="line">      is(<span class="type">T21ALUOp</span>.op_add) &#123; acc := ??? &#125;</span><br><span class="line">      is(<span class="type">T21ALUOp</span>.op_sub) &#123; acc := ??? &#125;</span><br><span class="line">      is(<span class="type">T21ALUOp</span>.op_neg) &#123; acc := ??? &#125;</span><br><span class="line">      is(<span class="type">T21ALUOp</span>.op_mov) &#123; acc := io.imm &#125;</span><br><span class="line">                  <span class="keyword">default</span> &#123; acc := acc &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Backup writes are only happen on BAK and SWP</span></span><br><span class="line">    switch(io.alu_op)&#123;</span><br><span class="line">      is(<span class="type">T21ALUOp</span>.op_bak) &#123; bak := acc &#125;</span><br><span class="line">      is(<span class="type">T21ALUOp</span>.op_swp) &#123; bak := acc &#125;</span><br><span class="line">                  <span class="keyword">default</span> &#123; bak := bak &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; otherwise &#123;</span><br><span class="line">    acc := acc</span><br><span class="line">    bak := bak</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  [...]</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Nothing particularly new here.</p>
<p>Moving on to negation. We could do a multiply with a signed negative 1, but We want to be sure that no multiplier resources are used for what is basically a fixed operation. Bit inversion followed by an add by 1 is equivalent:</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">T21Datapath</span>(<span class="params">abs_limit: <span class="type">Int</span></span>) <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  [...]</span><br><span class="line"></span><br><span class="line">  when(io.en) &#123;</span><br><span class="line">    <span class="comment">// Accumulator is written to on all but BAK instructions</span></span><br><span class="line">    switch(io.alu_op)&#123;</span><br><span class="line">      is(<span class="type">T21ALUOp</span>.op_neg) &#123; acc := ~acc + <span class="type">S</span>(<span class="number">1</span>, width bits) &#125;</span><br><span class="line">  [...]</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Here a Signed Literal of 1 with our parameterized width is added to a bitwise negation of the accumulator and assigned back to the accumulator. Here is where it gets interesting…</p>
<h3 id="Spinal-Clamp"><a href="#Spinal-Clamp" class="headerlink" title="Spinal Clamp"></a>Spinal Clamp</h3><p>We need to implement a saturated addition and subtraction: A Clamp. I Verilog, I would have to create a whole new set of modules to implement this in a clean code way (we are ignoring size efficiency for another time). To saturate and addition or subtraction we do essentially the same process:</p>
<p>1) Sign extend both operands by 1 bit.<br>2) Perform the operation<br>3) Check if the value is greater than our limits:<br>    a) If it is return the limit value, whatever it is.<br>    b) If it isn’t, return the result without the MSB so the result is the same width as the operands.</p>
<p>The extends and operations are relatively simple:</p>
<p>For addition:</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> res = op1.resize(op1.getWidth + <span class="number">1</span> bits) + op2.resize(op2.getWidth + <span class="number">1</span> bits)</span><br></pre></td></tr></table></figure>

<p>For subtraction:</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> res = op1.resize(op1.getWidth + <span class="number">1</span> bits) - op2.resize(op2.getWidth + <span class="number">1</span> bits)</span><br></pre></td></tr></table></figure>

<p>So result gives us the unclamped value with an extra bit so we don’t over or underflow.</p>
<p>What about clamping? That is common between the two so we ideally would want to avoid writing the code twice for each one. This is the magic of Spinal. We can declare hardware construct <em>functionally</em>. WE can declare this without or class and reuse it.:</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">clamp</span></span>(value: <span class="type">SInt</span>, limit: <span class="type">Int</span>): <span class="type">SInt</span> = &#123;</span><br><span class="line">  <span class="keyword">val</span> max_val = <span class="type">S</span>( limit, value.getWidth bits)</span><br><span class="line">  <span class="keyword">val</span> min_val = <span class="type">S</span>(-limit, value.getWidth bits)</span><br><span class="line">  <span class="type">Select</span>(</span><br><span class="line">    (value &gt; max_val) -&gt; max_val,</span><br><span class="line">    (value &lt; min_val) -&gt; min_val,</span><br><span class="line">    <span class="keyword">default</span>           -&gt; value</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>max_val</code> and <code>min_val</code> are local to the scope of the function se it can be “used” multiple times. Practically, this makes our code more readable. <code>Select()</code> blocks then implement a selection mux where we create the conditions under which replace the result with our limits.</p>
<p>We can then wrap our operations in this clamp construct, letting them both be functionally abstracted like the clamp.</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sat_add</span></span>(op1: <span class="type">SInt</span>, op2: <span class="type">SInt</span>, abs_lim: <span class="type">Int</span>): <span class="type">SInt</span> = &#123;</span><br><span class="line">  clamp(op1.resize(op1.getWidth + <span class="number">1</span> bits) + op2.resize(op2.getWidth + <span class="number">1</span> bits), abs_lim).resize(op2.getWidth bits)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sat_sub</span></span>(op1: <span class="type">SInt</span>, op2: <span class="type">SInt</span>, abs_lim: <span class="type">Int</span>): <span class="type">SInt</span> = &#123;</span><br><span class="line">  clamp(op1.resize(op1.getWidth + <span class="number">1</span> bits) - op2.resize(op2.getWidth + <span class="number">1</span> bits), abs_lim).resize(op2.getWidth bits)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Because the result of clamp is in itself a <code>SInt</code> we can perform any methods of the <code>SInt</code> on the result, so clamp itself doesn’t have to worry about any resizing and its operands and result are the same width. Lastly, we want to make these “package” functions, which in Scala means turning them into into objects (this is basically a consequence of running in the JVM).</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">clamp</span> <span class="keyword">extends</span> (<span class="params">(<span class="type">SInt</span>, <span class="type">Int</span></span>) <span class="title">=&gt;</span> <span class="title">SInt</span>) </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">apply</span></span>(value: <span class="type">SInt</span>, limit: <span class="type">Int</span>): <span class="type">SInt</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> max_val = <span class="type">S</span>( limit, value.getWidth bits)</span><br><span class="line">    <span class="keyword">val</span> min_val = <span class="type">S</span>(-limit, value.getWidth bits)</span><br><span class="line">    <span class="type">Select</span>(</span><br><span class="line">      (value &gt; max_val) -&gt; max_val,</span><br><span class="line">      (value &lt; min_val) -&gt; min_val,</span><br><span class="line">      <span class="keyword">default</span>           -&gt; value</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">sat_add</span> <span class="keyword">extends</span> (<span class="params">(<span class="type">SInt</span>, <span class="type">SInt</span>, <span class="type">Int</span></span>) <span class="title">=&gt;</span> <span class="title">SInt</span>) </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">apply</span></span>(op1: <span class="type">SInt</span>, op2: <span class="type">SInt</span>, abs_lim: <span class="type">Int</span>): <span class="type">SInt</span> = &#123;</span><br><span class="line">    clamp(op1.resize(op1.getWidth + <span class="number">1</span> bits) + op2.resize(op2.getWidth + <span class="number">1</span> bits), abs_lim).resize(op2.getWidth bits)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">sat_sub</span> <span class="keyword">extends</span> (<span class="params">(<span class="type">SInt</span>, <span class="type">SInt</span>, <span class="type">Int</span></span>) <span class="title">=&gt;</span> <span class="title">SInt</span>) </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">apply</span></span>(op1: <span class="type">SInt</span>, op2: <span class="type">SInt</span>, abs_lim: <span class="type">Int</span>): <span class="type">SInt</span> = &#123;</span><br><span class="line">    clamp(op1.resize(op1.getWidth + <span class="number">1</span> bits) - op2.resize(op2.getWidth + <span class="number">1</span> bits), abs_lim).resize(op2.getWidth bits)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>I’m not going to go crazy into detail on this as this is more of a matter of Scala as opposed to Spinal but put simply we are creating objects that extend a function prototype and then define the apply method for that object to implement the function itself.</p>
<h3 id="Putting-it-All-Together"><a href="#Putting-it-All-Together" class="headerlink" title="Putting it All Together"></a>Putting it All Together</h3><p>We have our registers, our operation Enum, our IO, functional abstractions for clamping and saturated operations. Put all together, this is my <code>T21Datapath.scala</code>:</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> <span class="type">TIS100</span>.<span class="type">T21</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> spinal.core._</span><br><span class="line"><span class="keyword">import</span> spinal.lib._</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">T21ALUOp</span> <span class="keyword">extends</span> <span class="title">SpinalEnum</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">val</span> op_bak, op_swp, op_add, op_sub, op_neg, op_mov = newElement()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">clamp</span> <span class="keyword">extends</span> (<span class="params">(<span class="type">SInt</span>, <span class="type">Int</span></span>) <span class="title">=&gt;</span> <span class="title">SInt</span>) </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">apply</span></span>(value: <span class="type">SInt</span>, limit: <span class="type">Int</span>): <span class="type">SInt</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> max_val = <span class="type">S</span>( limit, value.getWidth bits)</span><br><span class="line">    <span class="keyword">val</span> min_val = <span class="type">S</span>(-limit, value.getWidth bits)</span><br><span class="line">    <span class="type">Select</span>(</span><br><span class="line">      (value &gt; max_val) -&gt; max_val,</span><br><span class="line">      (value &lt; min_val) -&gt; min_val,</span><br><span class="line">      <span class="keyword">default</span>           -&gt; value</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">sat_add</span> <span class="keyword">extends</span> (<span class="params">(<span class="type">SInt</span>, <span class="type">SInt</span>, <span class="type">Int</span></span>) <span class="title">=&gt;</span> <span class="title">SInt</span>) </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">apply</span></span>(op1: <span class="type">SInt</span>, op2: <span class="type">SInt</span>, abs_lim: <span class="type">Int</span>): <span class="type">SInt</span> = &#123;</span><br><span class="line">    clamp(op1.resize(op1.getWidth + <span class="number">1</span> bits) + op2.resize(op2.getWidth + <span class="number">1</span> bits), abs_lim).resize(op2.getWidth bits)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">sat_sub</span> <span class="keyword">extends</span> (<span class="params">(<span class="type">SInt</span>, <span class="type">SInt</span>, <span class="type">Int</span></span>) <span class="title">=&gt;</span> <span class="title">SInt</span>) </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">apply</span></span>(op1: <span class="type">SInt</span>, op2: <span class="type">SInt</span>, abs_lim: <span class="type">Int</span>): <span class="type">SInt</span> = &#123;</span><br><span class="line">    clamp(op1.resize(op1.getWidth + <span class="number">1</span> bits) - op2.resize(op2.getWidth + <span class="number">1</span> bits), abs_lim).resize(op2.getWidth bits)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">T21Datapath</span>(<span class="params">abs_limit: <span class="type">Int</span></span>) <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="keyword">val</span> width = log2Up(<span class="number">2</span>*abs_limit+<span class="number">1</span>)</span><br><span class="line">  <span class="keyword">val</span> io = <span class="keyword">new</span> <span class="type">Bundle</span> &#123;</span><br><span class="line">    <span class="keyword">val</span> imm  = in  <span class="type">SInt</span>(width bits)</span><br><span class="line">    <span class="keyword">val</span> alu_op = in  (<span class="type">T21ALUOp</span>())</span><br><span class="line">    <span class="keyword">val</span> dout   = out <span class="type">SInt</span>(width bits)</span><br><span class="line">    <span class="keyword">val</span> en     = in  <span class="type">Bool</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">val</span> acc = <span class="type">Reg</span>(<span class="type">SInt</span>(width bits)) init(<span class="number">0</span>)</span><br><span class="line">  <span class="keyword">val</span> bak = <span class="type">Reg</span>(<span class="type">SInt</span>(width bits)) init(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Accumulator Assignment</span></span><br><span class="line">  when(io.en) &#123;</span><br><span class="line">    switch(io.alu_op)&#123;</span><br><span class="line">      is(<span class="type">T21ALUOp</span>.op_swp) &#123; acc := bak&#125;</span><br><span class="line">      is(<span class="type">T21ALUOp</span>.op_add) &#123; acc := sat_add(acc, io.imm, abs_limit)  &#125;</span><br><span class="line">      is(<span class="type">T21ALUOp</span>.op_sub) &#123; acc := sat_sub(acc, io.imm, abs_limit)  &#125;</span><br><span class="line">      is(<span class="type">T21ALUOp</span>.op_neg) &#123; acc := ~acc + <span class="type">S</span>(<span class="number">1</span>, width bits) &#125;</span><br><span class="line">      is(<span class="type">T21ALUOp</span>.op_mov) &#123; acc := io.imm &#125;</span><br><span class="line">                  <span class="keyword">default</span> &#123; acc := acc &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Backup Assignment</span></span><br><span class="line">    switch(io.alu_op)&#123;</span><br><span class="line">      is(<span class="type">T21ALUOp</span>.op_bak) &#123; bak := acc &#125;</span><br><span class="line">      is(<span class="type">T21ALUOp</span>.op_swp) &#123; bak := acc &#125;</span><br><span class="line">                  <span class="keyword">default</span> &#123; bak := bak &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; otherwise &#123;</span><br><span class="line">    acc := acc</span><br><span class="line">    bak := bak</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  io.dout := acc</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Other than the calls to the <code>sat_add</code> and <code>sat_sub</code> that we still had left, nothing should be new. And that is it. Within the same package we can add generators for both Verilog and VHDL with specified limit of 999 to give use the traditional -999 to 999 limits.</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">T21DatapathVerilog</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) &#123;</span><br><span class="line">    <span class="keyword">val</span> gen = <span class="type">SpinalVerilog</span>(<span class="keyword">new</span> <span class="type">T21Datapath</span>(<span class="number">999</span>))</span><br><span class="line">    gen.printPruned()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">T21DatapathVhdl</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) &#123;</span><br><span class="line">    <span class="keyword">val</span> gen = <span class="type">SpinalVhdl</span>(<span class="keyword">new</span> <span class="type">T21Datapath</span>(<span class="number">999</span>))</span><br><span class="line">    gen.printPruned()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Simulation"><a href="#Simulation" class="headerlink" title="Simulation"></a>Simulation</h2><p>So what now? IT turns out testing isn’t a pain here like it is in Verilog, at least in my opinion. Any good hardware testing setup needs a Golden Model, a point of comparison so we know our result are sane. This is actually pretty easy so I wont elaborate too hard and just show you.</p>
<h3 id="The-Golden-Goose"><a href="#The-Golden-Goose" class="headerlink" title="The Golden Goose"></a>The Golden Goose</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">T21Emulation</span>(<span class="params">abs_max: <span class="type">Int</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> acc_r = <span class="number">0</span></span><br><span class="line">  <span class="keyword">var</span> bak_r = <span class="number">0</span></span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">cb10</span></span>(in: <span class="type">Int</span>): <span class="type">Int</span> =</span><br><span class="line">    ( <span class="keyword">if</span> (in &gt; abs_max) abs_max <span class="keyword">else</span> (<span class="keyword">if</span> (in &lt; -abs_max) -abs_max <span class="keyword">else</span> in))</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">bak</span></span>(          ): <span class="type">Int</span> = &#123; bak_r = acc_r; acc_r &#125;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">swp</span></span>(          ): <span class="type">Int</span> = &#123; <span class="keyword">val</span> temp = bak_r; bak_r = acc_r; acc_r = temp; acc_r &#125;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">add</span></span>(imm11: <span class="type">Int</span>): <span class="type">Int</span> = &#123; acc_r = cb10(acc_r + imm11); acc_r &#125;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">sub</span></span>(imm11: <span class="type">Int</span>): <span class="type">Int</span> = &#123; acc_r = cb10(acc_r - imm11); acc_r &#125;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">neg</span></span>(          ): <span class="type">Int</span> = &#123; acc_r = cb10(<span class="number">-1</span> * acc_r); acc_r &#125;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">mov</span></span>(imm11: <span class="type">Int</span>): <span class="type">Int</span> = &#123; acc_r = imm11 ; acc_r &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Assert-My-Authority"><a href="#Assert-My-Authority" class="headerlink" title="Assert My Authority"></a>Assert My Authority</h3><p>Pretty simple. Instance this class with the same <code>abs_max</code> limit value and call the methods on it which then return the correct value of <code>ACC</code>. The test itself is a little more involved that I’m just going to show and explain a single function’s test and the others should follow from that:</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">trigger_dp</span></span>(dut: <span class="type">T21Datapath</span>, t21emu: <span class="type">T21Emulation</span>, expected: <span class="type">Int</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">    dut.io.en #= <span class="literal">true</span></span><br><span class="line">    dut.clockDomain.waitRisingEdge()</span><br><span class="line">    dut.io.en #= <span class="literal">false</span></span><br><span class="line">    dut.clockDomain.waitRisingEdge()</span><br><span class="line">    assert(dut.io.dout.toInt == expected)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_mov</span></span>(dut: <span class="type">T21Datapath</span>, t21emu: <span class="type">T21Emulation</span>, imm11: <span class="type">Int</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">    dut.io.alu_op #= <span class="type">T21ALUOp</span>.op_mov</span><br><span class="line">    dut.io.imm #= imm11</span><br><span class="line">    trigger_dp(dut, t21emu, t21emu.mov(imm11))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>trigger_dp</code> is a common set of functionality between all operation tests that takes the Datapath Hardware and the expected value. <code>test_mov</code> is the case of testing the mov into accumulator instruction. With this we give it not only a Datapath, but the emulation and the requested operand. In both of these we “poke” the inputs with the <code>#=</code> operator and then the specific operation calls the <code>trigger_dp</code> to run the hardware while also passing the expected result given by our Golden Model. All of the other operations are essentially the same although some such as <code>BAK</code> and <code>SWP</code> don’t have an operand. As pure functions, we need to stick these in a class:</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">T21DatapathSim</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">trigger_dp</span></span>(dut: <span class="type">T21Datapath</span>, expected: <span class="type">Int</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">        dut.io.en #= <span class="literal">true</span></span><br><span class="line">        dut.clockDomain.waitRisingEdge()</span><br><span class="line">        dut.io.en #= <span class="literal">false</span></span><br><span class="line">        dut.clockDomain.waitRisingEdge()</span><br><span class="line">        assert(dut.io.dout.toInt == expected)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">test_bak</span></span>(dut: <span class="type">T21Datapath</span>, t21emu: <span class="type">T21Emulation</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">      dut.io.alu_op #= <span class="type">T21ALUOp</span>.op_bak</span><br><span class="line">      trigger_dp(dut, t21emu.bak())</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">test_swp</span></span>(dut: <span class="type">T21Datapath</span>, t21emu: <span class="type">T21Emulation</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">      dut.io.alu_op #= <span class="type">T21ALUOp</span>.op_swp</span><br><span class="line">      trigger_dp(dut, t21emu.swp())</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">test_add</span></span>(dut: <span class="type">T21Datapath</span>, t21emu: <span class="type">T21Emulation</span>, imm11: <span class="type">Int</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">      dut.io.alu_op #= <span class="type">T21ALUOp</span>.op_add</span><br><span class="line">      dut.io.imm #= imm11</span><br><span class="line">      trigger_dp(dut, t21emu.add(imm11))</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">test_sub</span></span>(dut: <span class="type">T21Datapath</span>, t21emu: <span class="type">T21Emulation</span>, imm11: <span class="type">Int</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">      dut.io.alu_op #= <span class="type">T21ALUOp</span>.op_sub</span><br><span class="line">      dut.io.imm #= imm11</span><br><span class="line">      trigger_dp(dut, t21emu.sub(imm11))</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">test_neg</span></span>(dut: <span class="type">T21Datapath</span>, t21emu: <span class="type">T21Emulation</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">      dut.io.alu_op #= <span class="type">T21ALUOp</span>.op_neg</span><br><span class="line">      trigger_dp(dut, t21emu.neg())</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">test_mov</span></span>(dut: <span class="type">T21Datapath</span>, t21emu: <span class="type">T21Emulation</span>, imm11: <span class="type">Int</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">      dut.io.alu_op #= <span class="type">T21ALUOp</span>.op_mov</span><br><span class="line">      dut.io.imm #= imm11</span><br><span class="line">      trigger_dp(dut, t21emu.mov(imm11))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Building-the-Simulation"><a href="#Building-the-Simulation" class="headerlink" title="Building the Simulation"></a>Building the Simulation</h3><p>So those are the tests, but how do we run them? Well that is done with Spinal’s Simulation that uses a Verilator backend. We can stick this all up in a main function that takes two parameters, one for the absolute limit, and another for a “test size” that lets us make our tests more or less comprehensive at the expense of running longer. This test size is used to generate a set of operand pairs so that we test the system in a such a way that we know we are checking out clamping functionality:</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) &#123;</span><br><span class="line">  <span class="keyword">if</span> (args.length == <span class="number">0</span> || args.length == <span class="number">1</span>) &#123;</span><br><span class="line">      println(<span class="string">"Please enter the absolute value of the maximum value of the registers and a test size."</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Build out sets of operands to test.</span></span><br><span class="line">  <span class="keyword">val</span> test_size = args(<span class="number">1</span>).toInt</span><br><span class="line">  <span class="keyword">val</span> limit = args(<span class="number">0</span>).toInt</span><br><span class="line">  <span class="keyword">val</span> test_range = -test_size/<span class="number">2</span> to test_size/<span class="number">2</span></span><br><span class="line">  <span class="keyword">val</span> top    =  (limit - test_size) to limit</span><br><span class="line">  <span class="keyword">val</span> bottom = -limit to (-limit + test_size)</span><br><span class="line">  <span class="keyword">val</span> op_combos = <span class="type">List</span>(top, top, bottom, bottom, test_range, test_range).combinations(<span class="number">2</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>So we build three chunks of input values. One being the range of values on both sides of zero, and two that are ranges at the top and the bottoms of the defined behavior limits. <code>op_combo</code> uses some Scala magic to give us a <code>List</code> of tuples with every possible combination of the three (middle and middle, middle and top, middle and bottom, bottom and bottom, and top and top). All we have to do now is run every operation test on every one of these pairs (and sometimes twice such as in the case of subtraction). First lets build the harness for the tests:</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) &#123;</span><br><span class="line">    [...]</span><br><span class="line">    <span class="type">SimConfig</span>.withWave.doSim(<span class="keyword">new</span> <span class="type">T21Datapath</span>(limit))&#123; dut =&gt;</span><br><span class="line">      <span class="comment">// Define some functions for operation testing.</span></span><br><span class="line">      <span class="comment">// Refers to dut so must ne in the SimConfig</span></span><br><span class="line">      <span class="keyword">val</span> t21emu = <span class="keyword">new</span> <span class="type">T21Emulation</span>(limit)</span><br><span class="line">      dut.clockDomain.forkStimulus(period = <span class="number">10</span>)</span><br><span class="line">      op_combos.foreach &#123; <span class="keyword">case</span> op1_list :: op2_list :: <span class="type">Nil</span> =&gt;</span><br><span class="line">        <span class="keyword">for</span>(op1 &lt;- op1_list) &#123;</span><br><span class="line">          <span class="keyword">for</span> (op2 &lt;- op2_list) &#123;</span><br><span class="line">            ???</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>Here we pass the Spinal <code>SimConfig.withWave.doSim</code> the hardware constructor which is active under its block as <code>dut</code>. Within the block we instance our Golden Model emulator, fork off the system clock and setup our double loop on the operand pairs. We then (try to) pick the minimum amount of tests to run to cover all of our bases:</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(op1 &lt;- op1_list) &#123;</span><br><span class="line">    <span class="keyword">for</span> (op2 &lt;- op2_list) &#123;</span><br><span class="line">    <span class="comment">// Reg Stores (mov, bak, swp)</span></span><br><span class="line">    test_mov(dut, t21emu, op1); test_bak(dut, t21emu); test_mov(dut, t21emu, op2); test_swp(dut, t21emu);</span><br><span class="line">    <span class="comment">// Neg</span></span><br><span class="line">    test_mov(dut, t21emu, op1); test_neg(dut, t21emu); test_neg(dut, t21emu)</span><br><span class="line">    <span class="comment">// Add</span></span><br><span class="line">    test_mov(dut, t21emu, op1); test_bak(dut, t21emu); test_mov(dut, t21emu, op2); test_add(dut, t21emu, op1);</span><br><span class="line">    test_swp(dut, t21emu); test_add(dut, t21emu, op2)</span><br><span class="line">    <span class="comment">// Sub</span></span><br><span class="line">    test_mov(dut, t21emu, op1); test_bak(dut, t21emu); test_mov(dut, t21emu, op2); test_sub(dut, t21emu, op1);</span><br><span class="line">    test_swp(dut, t21emu); test_sub(dut, t21emu, op2)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> I’ll just say at this point I was really tired and while I know all these cases are more or less covered, there is a huge amount of test redundancy. But with a test size of only <code>20</code> we can run in about 15 seconds on my Sandy Bridge i5 2400. Our whole test file is then:</p>
 <figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> <span class="type">TIS100</span>.<span class="type">T21</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> spinal.core._</span><br><span class="line"><span class="keyword">import</span> spinal.sim._</span><br><span class="line"><span class="keyword">import</span> spinal.core.sim._</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Datapath golden model.</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">T21Emulation</span>(<span class="params">abs_max: <span class="type">Int</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> acc_r = <span class="number">0</span></span><br><span class="line">  <span class="keyword">var</span> bak_r = <span class="number">0</span></span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">cb10</span></span>(in: <span class="type">Int</span>): <span class="type">Int</span> =</span><br><span class="line">    ( <span class="keyword">if</span> (in &gt; abs_max) abs_max <span class="keyword">else</span> (<span class="keyword">if</span> (in &lt; -abs_max) -abs_max <span class="keyword">else</span> in))</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">bak</span></span>(          ): <span class="type">Int</span> = &#123; bak_r = acc_r; acc_r &#125;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">swp</span></span>(          ): <span class="type">Int</span> = &#123; <span class="keyword">val</span> temp = bak_r; bak_r = acc_r; acc_r = temp; acc_r &#125;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">add</span></span>(imm11: <span class="type">Int</span>): <span class="type">Int</span> = &#123; acc_r = cb10(acc_r + imm11); acc_r &#125;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">sub</span></span>(imm11: <span class="type">Int</span>): <span class="type">Int</span> = &#123; acc_r = cb10(acc_r - imm11); acc_r &#125;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">neg</span></span>(          ): <span class="type">Int</span> = &#123; acc_r = cb10(<span class="number">-1</span> * acc_r); acc_r &#125;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">mov</span></span>(imm11: <span class="type">Int</span>): <span class="type">Int</span> = &#123; acc_r = imm11 ; acc_r &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">T21DatapathSim</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">trigger_dp</span></span>(dut: <span class="type">T21Datapath</span>, expected: <span class="type">Int</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">        dut.io.en #= <span class="literal">true</span></span><br><span class="line">        dut.clockDomain.waitRisingEdge()</span><br><span class="line">        dut.io.en #= <span class="literal">false</span></span><br><span class="line">        dut.clockDomain.waitRisingEdge()</span><br><span class="line">        assert(dut.io.dout.toInt == expected)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">test_bak</span></span>(dut: <span class="type">T21Datapath</span>, t21emu: <span class="type">T21Emulation</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">      dut.io.alu_op #= <span class="type">T21ALUOp</span>.op_bak</span><br><span class="line">      trigger_dp(dut, t21emu.bak())</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">test_swp</span></span>(dut: <span class="type">T21Datapath</span>, t21emu: <span class="type">T21Emulation</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">      dut.io.alu_op #= <span class="type">T21ALUOp</span>.op_swp</span><br><span class="line">      trigger_dp(dut, t21emu.swp())</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">test_add</span></span>(dut: <span class="type">T21Datapath</span>, t21emu: <span class="type">T21Emulation</span>, imm11: <span class="type">Int</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">      dut.io.alu_op #= <span class="type">T21ALUOp</span>.op_add</span><br><span class="line">      dut.io.imm #= imm11</span><br><span class="line">      trigger_dp(dut, t21emu.add(imm11))</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">test_sub</span></span>(dut: <span class="type">T21Datapath</span>, t21emu: <span class="type">T21Emulation</span>, imm11: <span class="type">Int</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">      dut.io.alu_op #= <span class="type">T21ALUOp</span>.op_sub</span><br><span class="line">      dut.io.imm #= imm11</span><br><span class="line">      trigger_dp(dut, t21emu.sub(imm11))</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">test_neg</span></span>(dut: <span class="type">T21Datapath</span>, t21emu: <span class="type">T21Emulation</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">      dut.io.alu_op #= <span class="type">T21ALUOp</span>.op_neg</span><br><span class="line">      trigger_dp(dut, t21emu.neg())</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">test_mov</span></span>(dut: <span class="type">T21Datapath</span>, t21emu: <span class="type">T21Emulation</span>, imm11: <span class="type">Int</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">      dut.io.alu_op #= <span class="type">T21ALUOp</span>.op_mov</span><br><span class="line">      dut.io.imm #= imm11</span><br><span class="line">      trigger_dp(dut, t21emu.mov(imm11))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) &#123;</span><br><span class="line">    <span class="keyword">if</span> (args.length == <span class="number">0</span> || args.length == <span class="number">1</span>) &#123;</span><br><span class="line">        println(<span class="string">"Please enter the absolute value of the maximum value of the registers and a test size."</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Build out sets of operands to test.</span></span><br><span class="line">    <span class="keyword">val</span> test_size = args(<span class="number">1</span>).toInt</span><br><span class="line">    <span class="keyword">val</span> limit = args(<span class="number">0</span>).toInt</span><br><span class="line">    <span class="keyword">val</span> test_range = -test_size/<span class="number">2</span> to test_size/<span class="number">2</span></span><br><span class="line">    <span class="keyword">val</span> top    =  (limit - test_size) to limit</span><br><span class="line">    <span class="keyword">val</span> bottom = -limit to (-limit + test_size)</span><br><span class="line">    <span class="keyword">val</span> op_combos = <span class="type">List</span>(top, top, bottom, bottom, test_range, test_range).combinations(<span class="number">2</span>)</span><br><span class="line">    <span class="type">SimConfig</span>.withWave.doSim(<span class="keyword">new</span> <span class="type">T21Datapath</span>(limit))&#123; dut =&gt;</span><br><span class="line">      <span class="comment">// Define some functions for operation testing.</span></span><br><span class="line">      <span class="comment">// Refers to dut so must ne in the SimConfig</span></span><br><span class="line">      <span class="keyword">val</span> t21emu = <span class="keyword">new</span> <span class="type">T21Emulation</span>(limit)</span><br><span class="line">      dut.clockDomain.forkStimulus(period = <span class="number">10</span>)</span><br><span class="line">      op_combos.foreach &#123; <span class="keyword">case</span> op1_list :: op2_list :: <span class="type">Nil</span> =&gt;</span><br><span class="line">        <span class="keyword">for</span>(op1 &lt;- op1_list) &#123;</span><br><span class="line">          <span class="keyword">for</span> (op2 &lt;- op2_list) &#123;</span><br><span class="line">            <span class="comment">// Reg Stores (mov, bak, swp)</span></span><br><span class="line">            test_mov(dut, t21emu, op1); test_bak(dut, t21emu); test_mov(dut, t21emu, op2); test_swp(dut, t21emu);</span><br><span class="line">            <span class="comment">// Neg</span></span><br><span class="line">            test_mov(dut, t21emu, op1); test_neg(dut, t21emu); test_neg(dut, t21emu)</span><br><span class="line">            <span class="comment">// Add</span></span><br><span class="line">            test_mov(dut, t21emu, op1); test_bak(dut, t21emu); test_mov(dut, t21emu, op2); test_add(dut, t21emu, op1);</span><br><span class="line">            test_swp(dut, t21emu); test_add(dut, t21emu, op2)</span><br><span class="line">            <span class="comment">// Sub</span></span><br><span class="line">            test_mov(dut, t21emu, op1); test_bak(dut, t21emu); test_mov(dut, t21emu, op2); test_sub(dut, t21emu, op1);</span><br><span class="line">            test_swp(dut, t21emu); test_sub(dut, t21emu, op2)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Running-the-Simulation"><a href="#Running-the-Simulation" class="headerlink" title="Running the Simulation"></a>Running the Simulation</h3><p>This is then run with:</p>
<p><code>sbt &quot;runMain TIS100.T21.T21DatapathSim 999 20&quot;</code></p>
<p>For a test on a limit of -999 to 999 with 20 values on each of those ranges we defined.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"> ∴  drox@CROWBAR: sbt <span class="string">"runMain TIS100.T21.T21DatapathSim 999 20"</span></span><br><span class="line">[info] Loading settings <span class="keyword">for</span> project tispinal-100-build from plugins.sbt ...</span><br><span class="line">[info] Loading project definition from /mnt/d/fpga_dev/wslpwd/tispinal-100/project</span><br><span class="line">[info] Loading settings <span class="keyword">for</span> project tispinal-100 from build.sbt ...</span><br><span class="line">[info] Set current project to SpinalTemplateSbt (<span class="keyword">in</span> build file:/mnt/d/fpga_dev/wslpwd/tispinal-100/)</span><br><span class="line">[warn] Multiple main classes detected.  Run <span class="string">'show discoveredMainClasses'</span> to see the list</span><br><span class="line">[info] Running (fork) TIS100.T21.T21DatapathSim 999 20</span><br><span class="line">[info] [Runtime] SpinalHDL v1.3.5    git head : f0505d24810c8661a24530409359554b7cfa271a</span><br><span class="line">[info] [Runtime] JVM max memory : 3637.5MiB</span><br><span class="line">[info] [Runtime] Current date : 2019.06.10 05:12:49</span><br><span class="line">[info] [Progress] at 0.000 : Elaborate components</span><br><span class="line">[info] [Progress] at 0.144 : Checks and transforms</span><br><span class="line">[info] [Progress] at 0.252 : Generate Verilog</span><br><span class="line">[info] [Progress] at 0.258 :   emit T21Datapath</span><br><span class="line">[info] [Info] Number of registers : 22</span><br><span class="line">[info] [Done] at 0.325</span><br><span class="line">[info] [Progress] Simulation workspace <span class="keyword">in</span> /mnt/d/fpga_dev/wslpwd/tispinal-100/./simWorkspace/T21Datapath</span><br><span class="line">[info] [Progress] Verilator compilation started</span><br><span class="line">[info] [Progress] Verilator compilation <span class="keyword">done</span> <span class="keyword">in</span> 4471.435 ms</span><br><span class="line">[info] [Progress] Start T21Datapath <span class="built_in">test</span> simulation with seed -6375507200320811581, wave <span class="keyword">in</span> /mnt/d/fpga_dev/wslpwd/tispinal-100/./simWorkspace/T21Datapath/test.vcd</span><br><span class="line">[info] [Done] Simulation <span class="keyword">done</span> <span class="keyword">in</span> 2298.557 ms</span><br><span class="line">[success] Total time: 11 s, completed Jun 10, 2019 5:12:56 AM</span><br></pre></td></tr></table></figure>

<p>As we can see, our tests pass and we see that 22 registers are made, the minimum amount required for two registers holding values from -999 to 999. Thanks for reading. Especially if you made it this far.</p>
<p>Derrick</p>
<h2 id="Appendix-Codes"><a href="#Appendix-Codes" class="headerlink" title="Appendix: Codes"></a>Appendix: Codes</h2><h3 id="T21Datapath-scala"><a href="#T21Datapath-scala" class="headerlink" title="T21Datapath.scala"></a>T21Datapath.scala</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> <span class="type">TIS100</span>.<span class="type">T21</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> spinal.core._</span><br><span class="line"><span class="keyword">import</span> spinal.lib._</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">T21ALUOp</span> <span class="keyword">extends</span> <span class="title">SpinalEnum</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">val</span> op_bak, op_swp, op_add, op_sub, op_neg, op_mov = newElement()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">clamp</span> <span class="keyword">extends</span> (<span class="params">(<span class="type">SInt</span>, <span class="type">Int</span></span>) <span class="title">=&gt;</span> <span class="title">SInt</span>) </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">apply</span></span>(value: <span class="type">SInt</span>, limit: <span class="type">Int</span>): <span class="type">SInt</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> max_val = <span class="type">S</span>( limit, value.getWidth bits)</span><br><span class="line">    <span class="keyword">val</span> min_val = <span class="type">S</span>(-limit, value.getWidth bits)</span><br><span class="line">    <span class="type">Select</span>(</span><br><span class="line">      (value &gt; max_val) -&gt; max_val,</span><br><span class="line">      (value &lt; min_val) -&gt; min_val,</span><br><span class="line">      <span class="keyword">default</span>           -&gt; value</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">sat_add</span> <span class="keyword">extends</span> (<span class="params">(<span class="type">SInt</span>, <span class="type">SInt</span>, <span class="type">Int</span></span>) <span class="title">=&gt;</span> <span class="title">SInt</span>) </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">apply</span></span>(op1: <span class="type">SInt</span>, op2: <span class="type">SInt</span>, abs_lim: <span class="type">Int</span>): <span class="type">SInt</span> = &#123;</span><br><span class="line">    clamp(op1.resize(op1.getWidth + <span class="number">1</span> bits) + op2.resize(op2.getWidth + <span class="number">1</span> bits), abs_lim).resize(op2.getWidth bits)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">sat_sub</span> <span class="keyword">extends</span> (<span class="params">(<span class="type">SInt</span>, <span class="type">SInt</span>, <span class="type">Int</span></span>) <span class="title">=&gt;</span> <span class="title">SInt</span>) </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">apply</span></span>(op1: <span class="type">SInt</span>, op2: <span class="type">SInt</span>, abs_lim: <span class="type">Int</span>): <span class="type">SInt</span> = &#123;</span><br><span class="line">    clamp(op1.resize(op1.getWidth + <span class="number">1</span> bits) - op2.resize(op2.getWidth + <span class="number">1</span> bits), abs_lim).resize(op2.getWidth bits)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">T21Datapath</span>(<span class="params">abs_limit: <span class="type">Int</span></span>) <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="keyword">val</span> width = log2Up(<span class="number">2</span>*abs_limit+<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">val</span> io = <span class="keyword">new</span> <span class="type">Bundle</span> &#123;</span><br><span class="line">    <span class="keyword">val</span> imm    = in  <span class="type">SInt</span>(width bits)</span><br><span class="line">    <span class="keyword">val</span> alu_op = in  (<span class="type">T21ALUOp</span>())</span><br><span class="line">    <span class="keyword">val</span> dout   = out <span class="type">SInt</span>(width bits)</span><br><span class="line">    <span class="keyword">val</span> en     = in  <span class="type">Bool</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">val</span> acc = <span class="type">Reg</span>(<span class="type">SInt</span>(width bits)) init(<span class="number">0</span>)</span><br><span class="line">  <span class="keyword">val</span> bak = <span class="type">Reg</span>(<span class="type">SInt</span>(width bits)) init(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Accumulator Assignment</span></span><br><span class="line">  when(io.en) &#123;</span><br><span class="line">    switch(io.alu_op)&#123;</span><br><span class="line">      is(<span class="type">T21ALUOp</span>.op_swp) &#123; acc := bak&#125;</span><br><span class="line">      is(<span class="type">T21ALUOp</span>.op_add) &#123; acc := sat_add(acc, io.imm, abs_limit)  &#125;</span><br><span class="line">      is(<span class="type">T21ALUOp</span>.op_sub) &#123; acc := sat_sub(acc, io.imm, abs_limit)  &#125;</span><br><span class="line">      is(<span class="type">T21ALUOp</span>.op_neg) &#123; acc := ~acc + <span class="type">S</span>(<span class="number">1</span>, width bits) &#125;</span><br><span class="line">      is(<span class="type">T21ALUOp</span>.op_mov) &#123; acc := io.imm &#125;</span><br><span class="line">                  <span class="keyword">default</span> &#123; acc := acc &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Backup Assignment</span></span><br><span class="line">    switch(io.alu_op)&#123;</span><br><span class="line">      is(<span class="type">T21ALUOp</span>.op_bak) &#123; bak := acc &#125;</span><br><span class="line">      is(<span class="type">T21ALUOp</span>.op_swp) &#123; bak := acc &#125;</span><br><span class="line">                  <span class="keyword">default</span> &#123; bak := bak &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; otherwise &#123;</span><br><span class="line">    acc := acc</span><br><span class="line">    bak := bak</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  io.dout := acc</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Generate the MyTopLevel's Verilog</span></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">T21DatapathVerilog</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) &#123;</span><br><span class="line">    <span class="keyword">val</span> gen = <span class="type">SpinalVerilog</span>(<span class="keyword">new</span> <span class="type">T21Datapath</span>(<span class="number">999</span>))</span><br><span class="line">    gen.printPruned()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Generate the MyTopLevel's VHDL</span></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">T21DatapathVhdl</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) &#123;</span><br><span class="line">    <span class="keyword">val</span> gen = <span class="type">SpinalVhdl</span>(<span class="keyword">new</span> <span class="type">T21Datapath</span>(<span class="number">999</span>))</span><br><span class="line">    gen.printPruned()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//Define a custom SpinalHDL configuration with synchronous reset instead of the default asynchronous one. This configuration can be reused everywhere</span></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">MySpinalConfig</span> <span class="keyword">extends</span> <span class="title">SpinalConfig</span>(<span class="params">defaultConfigForClockDomains = <span class="type">ClockDomainConfig</span>(resetKind = <span class="type">SYNC</span></span>))</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">//Generate</span> <span class="title">the</span> <span class="title">MyTopLevel</span>'<span class="title">s</span> <span class="title">Verilog</span> <span class="title">using</span> <span class="title">the</span> <span class="title">above</span> <span class="title">custom</span> <span class="title">configuration</span>.</span></span><br><span class="line"><span class="class"><span class="title">object</span> <span class="title">T21DatapathVerilogWithCustomConfig</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) &#123;</span><br><span class="line">    <span class="type">MySpinalConfig</span>.generateVerilog(<span class="keyword">new</span> <span class="type">T21Datapath</span>(<span class="number">999</span>))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="T21DatapathSim-scala"><a href="#T21DatapathSim-scala" class="headerlink" title="T21DatapathSim.scala"></a>T21DatapathSim.scala</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> <span class="type">TIS100</span>.<span class="type">T21</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> spinal.core._</span><br><span class="line"><span class="keyword">import</span> spinal.sim._</span><br><span class="line"><span class="keyword">import</span> spinal.core.sim._</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Datapath golden model.</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">T21Emulation</span>(<span class="params">abs_max: <span class="type">Int</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> acc_r = <span class="number">0</span></span><br><span class="line">  <span class="keyword">var</span> bak_r = <span class="number">0</span></span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">cb10</span></span>(in: <span class="type">Int</span>): <span class="type">Int</span> =</span><br><span class="line">    ( <span class="keyword">if</span> (in &gt; abs_max) abs_max <span class="keyword">else</span> (<span class="keyword">if</span> (in &lt; -abs_max) -abs_max <span class="keyword">else</span> in))</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">bak</span></span>(          ): <span class="type">Int</span> = &#123; bak_r = acc_r; acc_r &#125;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">swp</span></span>(          ): <span class="type">Int</span> = &#123; <span class="keyword">val</span> temp = bak_r; bak_r = acc_r; acc_r = temp; acc_r &#125;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">add</span></span>(imm11: <span class="type">Int</span>): <span class="type">Int</span> = &#123; acc_r = cb10(acc_r + imm11); acc_r &#125;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">sub</span></span>(imm11: <span class="type">Int</span>): <span class="type">Int</span> = &#123; acc_r = cb10(acc_r - imm11); acc_r &#125;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">neg</span></span>(          ): <span class="type">Int</span> = &#123; acc_r = cb10(<span class="number">-1</span> * acc_r); acc_r &#125;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">mov</span></span>(imm11: <span class="type">Int</span>): <span class="type">Int</span> = &#123; acc_r = imm11 ; acc_r &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">T21DatapathSim</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">trigger_dp</span></span>(dut: <span class="type">T21Datapath</span>, expected: <span class="type">Int</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">        dut.io.en #= <span class="literal">true</span></span><br><span class="line">        dut.clockDomain.waitRisingEdge()</span><br><span class="line">        dut.io.en #= <span class="literal">false</span></span><br><span class="line">        dut.clockDomain.waitRisingEdge()</span><br><span class="line">        assert(dut.io.dout.toInt == expected)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">test_bak</span></span>(dut: <span class="type">T21Datapath</span>, t21emu: <span class="type">T21Emulation</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">      dut.io.alu_op #= <span class="type">T21ALUOp</span>.op_bak</span><br><span class="line">      trigger_dp(dut, t21emu.bak())</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">test_swp</span></span>(dut: <span class="type">T21Datapath</span>, t21emu: <span class="type">T21Emulation</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">      dut.io.alu_op #= <span class="type">T21ALUOp</span>.op_swp</span><br><span class="line">      trigger_dp(dut, t21emu.swp())</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">test_add</span></span>(dut: <span class="type">T21Datapath</span>, t21emu: <span class="type">T21Emulation</span>, imm11: <span class="type">Int</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">      dut.io.alu_op #= <span class="type">T21ALUOp</span>.op_add</span><br><span class="line">      dut.io.imm #= imm11</span><br><span class="line">      trigger_dp(dut, t21emu.add(imm11))</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">test_sub</span></span>(dut: <span class="type">T21Datapath</span>, t21emu: <span class="type">T21Emulation</span>, imm11: <span class="type">Int</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">      dut.io.alu_op #= <span class="type">T21ALUOp</span>.op_sub</span><br><span class="line">      dut.io.imm #= imm11</span><br><span class="line">      trigger_dp(dut, t21emu.sub(imm11))</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">test_neg</span></span>(dut: <span class="type">T21Datapath</span>, t21emu: <span class="type">T21Emulation</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">      dut.io.alu_op #= <span class="type">T21ALUOp</span>.op_neg</span><br><span class="line">      trigger_dp(dut, t21emu.neg())</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">test_mov</span></span>(dut: <span class="type">T21Datapath</span>, t21emu: <span class="type">T21Emulation</span>, imm11: <span class="type">Int</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">      dut.io.alu_op #= <span class="type">T21ALUOp</span>.op_mov</span><br><span class="line">      dut.io.imm #= imm11</span><br><span class="line">      trigger_dp(dut, t21emu.mov(imm11))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) &#123;</span><br><span class="line">    <span class="keyword">if</span> (args.length == <span class="number">0</span> || args.length == <span class="number">1</span>) &#123;</span><br><span class="line">        println(<span class="string">"Please enter the absolute value of the maximum value of the registers and a test size."</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Build out sets of operands to test.</span></span><br><span class="line">    <span class="keyword">val</span> test_size = args(<span class="number">1</span>).toInt</span><br><span class="line">    <span class="keyword">val</span> limit = args(<span class="number">0</span>).toInt</span><br><span class="line">    <span class="keyword">val</span> test_range = -test_size/<span class="number">2</span> to test_size/<span class="number">2</span></span><br><span class="line">    <span class="keyword">val</span> top    =  (limit - test_size) to limit</span><br><span class="line">    <span class="keyword">val</span> bottom = -limit to (-limit + test_size)</span><br><span class="line">    <span class="keyword">val</span> op_combos = <span class="type">List</span>(top, top, bottom, bottom, test_range, test_range).combinations(<span class="number">2</span>)</span><br><span class="line">    <span class="type">SimConfig</span>.withWave.doSim(<span class="keyword">new</span> <span class="type">T21Datapath</span>(limit))&#123; dut =&gt;</span><br><span class="line">      <span class="comment">// Define some functions for operation testing.</span></span><br><span class="line">      <span class="comment">// Refers to dut so must ne in the SimConfig</span></span><br><span class="line">      <span class="keyword">val</span> t21emu = <span class="keyword">new</span> <span class="type">T21Emulation</span>(limit)</span><br><span class="line">      dut.clockDomain.forkStimulus(period = <span class="number">10</span>)</span><br><span class="line">      op_combos.foreach &#123; <span class="keyword">case</span> op1_list :: op2_list :: <span class="type">Nil</span> =&gt;</span><br><span class="line">        <span class="keyword">for</span>(op1 &lt;- op1_list) &#123;</span><br><span class="line">          <span class="keyword">for</span> (op2 &lt;- op2_list) &#123;</span><br><span class="line">            <span class="comment">// Reg Stores (mov, bak, swp)</span></span><br><span class="line">            test_mov(dut, t21emu, op1); test_bak(dut, t21emu); test_mov(dut, t21emu, op2); test_swp(dut, t21emu);</span><br><span class="line">            <span class="comment">// Neg</span></span><br><span class="line">            test_mov(dut, t21emu, op1); test_neg(dut, t21emu); test_neg(dut, t21emu)</span><br><span class="line">            <span class="comment">// Add</span></span><br><span class="line">            test_mov(dut, t21emu, op1); test_bak(dut, t21emu); test_mov(dut, t21emu, op2); test_add(dut, t21emu, op1);</span><br><span class="line">            test_swp(dut, t21emu); test_add(dut, t21emu, op2)</span><br><span class="line">            <span class="comment">// Sub</span></span><br><span class="line">            test_mov(dut, t21emu, op1); test_bak(dut, t21emu); test_mov(dut, t21emu, op2); test_sub(dut, t21emu, op1);</span><br><span class="line">            test_swp(dut, t21emu); test_sub(dut, t21emu, op2)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


  </div>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>Si us plau, activa JavaScript per poder veure el contingut.</noscript>
        </div>
    </div>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writings</a></li>
         
          <li><a href="https://droxpopuli.bandcamp.com">Music</a></li>
         
          <li><a href="https://github.com/droxpopuli">Code</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Introduction"><span class="toc-number">1.</span> <span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Growing-a-Spine-al"><span class="toc-number">2.</span> <span class="toc-text">Growing a Spine(al)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#The-Task-The-TIS-100"><span class="toc-number">3.</span> <span class="toc-text">The Task: The TIS-100</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#The-Datapath"><span class="toc-number">4.</span> <span class="toc-text">The Datapath</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#IO"><span class="toc-number">4.1.</span> <span class="toc-text">IO</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Going-Beyond-the-Zach"><span class="toc-number">4.2.</span> <span class="toc-text">Going Beyond the Zach</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Accumulate-Your-Backups"><span class="toc-number">4.3.</span> <span class="toc-text">Accumulate Your Backups</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Connect-me-to-the-Operator-Please"><span class="toc-number">4.4.</span> <span class="toc-text">Connect me to the Operator Please</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Spinal-Clamp"><span class="toc-number">4.5.</span> <span class="toc-text">Spinal Clamp</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Putting-it-All-Together"><span class="toc-number">4.6.</span> <span class="toc-text">Putting it All Together</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Simulation"><span class="toc-number">5.</span> <span class="toc-text">Simulation</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#The-Golden-Goose"><span class="toc-number">5.1.</span> <span class="toc-text">The Golden Goose</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Assert-My-Authority"><span class="toc-number">5.2.</span> <span class="toc-text">Assert My Authority</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Building-the-Simulation"><span class="toc-number">5.3.</span> <span class="toc-text">Building the Simulation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Running-the-Simulation"><span class="toc-number">5.4.</span> <span class="toc-text">Running the Simulation</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Appendix-Codes"><span class="toc-number">6.</span> <span class="toc-text">Appendix: Codes</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#T21Datapath-scala"><span class="toc-number">6.1.</span> <span class="toc-text">T21Datapath.scala</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#T21DatapathSim-scala"><span class="toc-number">6.2.</span> <span class="toc-text">T21DatapathSim.scala</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://drox.zone/2019/06/09/Tessellated-Spinal-Fluid/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://drox.zone/2019/06/09/Tessellated-Spinal-Fluid/&text=Tessellated_Spinal_Fluid"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://drox.zone/2019/06/09/Tessellated-Spinal-Fluid/&title=Tessellated_Spinal_Fluid"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://drox.zone/2019/06/09/Tessellated-Spinal-Fluid/&is_video=false&description=Tessellated_Spinal_Fluid"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Tessellated_Spinal_Fluid&body=Check out this article: http://drox.zone/2019/06/09/Tessellated-Spinal-Fluid/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://drox.zone/2019/06/09/Tessellated-Spinal-Fluid/&title=Tessellated_Spinal_Fluid"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://drox.zone/2019/06/09/Tessellated-Spinal-Fluid/&title=Tessellated_Spinal_Fluid"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://drox.zone/2019/06/09/Tessellated-Spinal-Fluid/&title=Tessellated_Spinal_Fluid"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://drox.zone/2019/06/09/Tessellated-Spinal-Fluid/&title=Tessellated_Spinal_Fluid"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://drox.zone/2019/06/09/Tessellated-Spinal-Fluid/&name=Tessellated_Spinal_Fluid&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menú</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Compartir</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Cap amunt</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2020 Derrick Miller
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writings</a></li>
         
          <li><a href="https://droxpopuli.bandcamp.com">Music</a></li>
         
          <li><a href="https://github.com/droxpopuli">Code</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">

    <!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->

    <script type="text/javascript">
        var disqus_shortname = 'droxzone';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>


</body>
</html>
